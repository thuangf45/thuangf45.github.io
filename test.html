<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>WebSocket Packet Client</title><link rel="icon" type="image/png" href="./favicon.png"></head><body><script>let websocket=null,connectTimeout=null,sendQueue=[],sendThrottle=null,queueMaxSize=20;function init(){const e=`${"https:"===window.location.protocol?"wss:":"ws:"}//${window.location.host}`;document.myform.url.value=e,document.myform.inputtext.value="Hello World!",document.myform.disconnectButton.disabled=!0,document.myform.sendButton.disabled=!0,document.myform.outputtext.value=""}function doConnect(){if(websocket&&websocket.readyState!==WebSocket.CLOSED)return writeToScreen("Closing old...\n"),void websocket.close(1e3,"Reconnecting");websocket=new WebSocket(document.myform.url.value),websocket.binaryType="arraybuffer",connectTimeout=setTimeout(()=>{websocket.readyState===WebSocket.CONNECTING&&(writeToScreen("Connect timeout – Check server!\n"),websocket.close(1e3,"Timeout"))},1e4),websocket.onopen=function(e){clearTimeout(connectTimeout),onOpen(e)},websocket.onclose=function(e){clearTimeout(connectTimeout),onClose(e)},websocket.onmessage=function(e){onMessage(e)},websocket.onerror=function(e){clearTimeout(connectTimeout),onError(e)},writeToScreen("Connecting to: "+document.myform.url.value+"\n")}function onOpen(e){writeToScreen("connected\n"),document.myform.connectButton.disabled=!0,document.myform.disconnectButton.disabled=!1,document.myform.sendButton.disabled=!1,flushQueue()}function onClose(e){writeToScreen(`disconnected (Code: ${e.code}, Reason: ${e.reason})\n`),document.myform.connectButton.disabled=!1,document.myform.disconnectButton.disabled=!0,document.myform.sendButton.disabled=!0,websocket=null,1e3!==e.code&&sendQueue.length<10?(writeToScreen("Auto-reconnecting in 2 seconds...\n"),setTimeout(doConnect,2e3)):sendQueue.length>=10&&(writeToScreen("Queue overload detected! Clearing queue and pausing reconnect.\n"),sendQueue=[])}function onMessage(e){if(e.data instanceof ArrayBuffer){const t=new Uint8Array(e.data),n=t[0]|t[1]<<8|t[2]<<16|t[3]<<24,o=t.slice(4,4+n),c=t.slice(4+n),r=new TextDecoder;let u,s;try{const e=r.decode(o);switch(u=JSON.parse(e),u.ContentType){case"application/json":try{const e=r.decode(c);s=JSON.parse(e)}catch(e){s=r.decode(c)}break;case"text/plain":case"text/html":s=r.decode(c);break;default:s=c}s instanceof Uint8Array?writeToScreen(`[${u.Type}] Received binary ${s.length} bytes\n`):writeToScreen(`[${u.Type}] Response: ${JSON.stringify(s)}\n`)}catch(e){writeToScreen("Lỗi khi parse phản hồi: "+e.message+"\n")}}else writeToScreen("response: "+e.data+"\n")}function onError(e){writeToScreen(`error: ${e.message||"Unknown"}\n`),console.error(e),websocket&&websocket.readyState===WebSocket.OPEN&&websocket.close(1e3,"Client closing due to error"),sendThrottle&&(clearInterval(sendThrottle),sendThrottle=null)}function sendPacket(e,t,n){const o=new TextEncoder,c={Type:e,Url:t,ContentType:"application/json"},r=JSON.stringify(c),u=JSON.stringify(n),s=o.encode(r),d=o.encode(u),i=new Uint8Array(4+s.length+d.length),l=s.length;return i[0]=255&l,i[1]=l>>8&255,i[2]=l>>16&255,i[3]=l>>24&255,i.set(s,4),i.set(d,4+s.length),console.log("[WS] Creating packet for queue:",{header:c,body:n,bufferLength:i.length}),i}function safeSend(e){sendQueue.push(e),writeToScreen(`Queued packet. Queue size: ${sendQueue.length}/${queueMaxSize}\n`),sendQueue.length>queueMaxSize&&(sendQueue.shift(),writeToScreen("Queue full! Dropped oldest packet.\n")),startThrottleIfNeeded()}function startThrottleIfNeeded(){!sendThrottle&&websocket&&websocket.readyState===WebSocket.OPEN&&sendQueue.length>0&&(writeToScreen(`Starting throttle. Initial queue: ${sendQueue.length}\n`),sendThrottle=setInterval(()=>{if(sendQueue.length>0&&websocket.readyState===WebSocket.OPEN){const e=sendQueue.shift();try{websocket.send(e),writeToScreen(`Sent packet. Remaining queue: ${sendQueue.length}\n`),console.log(`[WS] Sent from queue, remaining: ${sendQueue.length}`)}catch(t){writeToScreen(`Send error: ${t.message}. Re-queueing.\n`),sendQueue.unshift(e)}}else 0===sendQueue.length&&(writeToScreen("Throttle stopped. Queue empty.\n"),clearInterval(sendThrottle),sendThrottle=null)},150))}function flushQueue(){websocket&&websocket.readyState===WebSocket.OPEN?startThrottleIfNeeded():writeToScreen("Cannot flush: WS not open.\n")}function sendText(){let e=document.myform.inputtext.value.trim();if(!e)return;document.myform.sendButton.disabled=!0;safeSend(sendPacket("/wss","SendChat",{text:e})),writeToScreen("sent(packet): "+e+"\n"),setTimeout(()=>{document.myform.sendButton.disabled=!1},600)}function clearText(){document.myform.outputtext.value=""}function doDisconnect(){websocket&&websocket.readyState===WebSocket.OPEN&&websocket.close(1e3,"Manual disconnect"),sendThrottle&&(clearInterval(sendThrottle),sendThrottle=null),sendQueue=[],writeToScreen("Disconnected. Queue cleared.\n")}function writeToScreen(e){document.myform.outputtext.value+=e,document.myform.outputtext.scrollTop=document.myform.outputtext.scrollHeight}window.addEventListener("load",init,!1)</script><form name="myform"><p><textarea name="url" cols="50" rows="1"></textarea></p><p><input type="button" name="connectButton" value="Connect" onclick="doConnect()"> <input type="button" name="disconnectButton" value="Disconnect" onclick="doDisconnect()"></p><p><textarea name="outputtext" cols="50" rows="20" readonly="readonly"></textarea></p><p><textarea name="inputtext" cols="50" rows="1"></textarea></p><p><input type="button" name="sendButton" value="Send" onclick="sendText()" disabled="disabled"> <input type="button" name="clearButton" value="Clear" onclick="clearText()"></p></form></body></html>